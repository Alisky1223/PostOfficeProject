@page "/PostOfficeProducts"
@using CommonDll.Dto
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@using System.Net.Http.Json
@using System.Globalization
@using System.Reflection
@using System.Threading
@using PostOfficeFrontendProject__all_interactive.Interface
@using PostOfficeFrontendProject__all_interactive.Mapper
@inject HttpClient httpClient
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IProductsMiddelware productsMiddelware
@inject IDataPassHelper dataPassHelper

<MudRTLProvider RightToLeft="@_rightToLeft">

    <MudItem Class="d-flex align-center justify-center mud-theme-primary  mud-elevation-25" Style=" height:60px; width:100%; margin-top:0px; margin-bottom:20px;">

        <MudText Typo="Typo.h5">مشاهده اطلاعات مرسوله ها</MudText>

    </MudItem>

    <MudDataGrid Height="60vh" FixedHeader @ondblclick="DoubleClick"  T="ProductDto" Loading="isLoading" Items="@products" Dense="@dense" Hover="@hover" Bordered="@bordered" Striped="@striped" Filterable="true" QuickFilter="_quickFilterProducts" SelectOnRowClick @bind-SelectedItem="@selectedProducts">

        <ToolBarContent>

            <MudText Typo="Typo.h5" Style="margin:20px"><b>لیست مرسولات</b></MudText>

            <MudSpacer />

            <MudTextField @bind-Value="searchString" Immediate="true" Placeholder="جستجو" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>

        </ToolBarContent>

        <Columns>

            <PropertyColumn Property="x => x.ProductName" Title="نام مرسوله" HeaderStyle="background:#ADD8E6;color:#333;" StickyRight="true" />

            <PropertyColumn Property="x => x.Price" Title="ارزش مرسوله" HeaderStyle="background:#ADD8E6;color:#333;"/>

            <PropertyColumn Property="x => x.Description" Title="توضیحات مرسوله" HeaderStyle="background:#ADD8E6;color:#333;"  />

            <PropertyColumn Property="x => x.ProductType.ProductsTypeToString()" Title="نوع مرسوله" HeaderStyle="background:#ADD8E6;color:#333;" />

            <PropertyColumn Property="x => x.TransportStatus.ProductStatusToString()" Title="وضعیت مرسوله" HeaderStyle="background:#ADD8E6;color:#333;" />

            <TemplateColumn HeaderStyle="background:#ADD8E6;color:#333;" Title="عملیات">

                <CellTemplate>

                    <MudStack Row>


                        <MudButton Style="margin-right:10px" Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditProduct(context.Item.Id))">

                            ویرایش

                        </MudButton>

                        <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="@(() =>DeletedProduct(context.Item))">حذف</MudButton>



                    </MudStack>

                </CellTemplate>

            </TemplateColumn>

        </Columns>

        <PagerContent>

            <MudDataGridPager />

        </PagerContent>

    </MudDataGrid>

    <MudPaper Elevation="0" Class="d-flex align-center justify-end " Style="margin-top:20px">

        <MudButton Class="main-button" Style="margin-left:10px" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="GoToAddProductPage">افزودن</MudButton>

        <MudButton Class="main-button" Variant="Variant.Filled" Color="Color.Tertiary" Size="Size.Large" OnClick="GoToMainPage">بازگشت به صفحه اصلی</MudButton>

    </MudPaper>

</MudRTLProvider>

<style>

    .red-header {
        background-color: #87CEFA;
        color: #fff; /* سفید برای خوانایی متن */
    }

</style>

@code {

    #region Props

    private bool hover = true;

    private bool dense = true;

    private bool striped = true;

    private bool bordered = true;

    private bool isLoading = false;

    private bool _rightToLeft = true;

    private string searchString = "";

    private ProductDto selectedProducts = new();

    private List<ProductDto> products = new List<ProductDto>();

    protected async override Task OnInitializedAsync()
    {

        await LoadProducts();

    }

    #endregion

    #region LoadProducts

    private async Task LoadProducts()
    {
        try
        {
            isLoading = true;
            products = await productsMiddelware.GetAllProductsAsync();  // لیست جدید
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Snackbar.Add(ex.Message);

        }
        finally
        {
            isLoading = false;
        }
    }

    #endregion

    #region Filter

    private Func<ProductDto, bool> _quickFilterProducts => x =>
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        var fields = new List<string?>
                            {
        x.ProductName?.ToString(),
        x.Price.ToString(),
        x.Description.ToString(),
        x.ProductType?.ProductsTypeToString(),

                            };

        return fields.Any(f => !string.IsNullOrEmpty(f) &&
                               f.Contains(searchString, StringComparison.OrdinalIgnoreCase));
    };

    #endregion

    #region GoToMainPage

    private void GoToMainPage()
    {

        NavigationManager.NavigateTo("/MainPage");

    }
    #endregion

    #region DeleteItem

    private async Task DeletedProduct(ProductDto deletedProduct)
    {

        bool? confirmed = await DialogService.ShowMessageBox(
    "تأیید حذف",
    $"آیا مطمئن هستید که می‌خواهید محصول '{deletedProduct.ProductName}' را حذف کنید؟",
    yesText: "بله",
    noText: "خیر"
    );

        if (confirmed == true)
        {
            products = products.Where(s => s != deletedProduct).ToList();
        }

    }

    #endregion

    #region EditProduct

    private void EditProduct(int id)
    {

        dataPassHelper.SetProudctId(id);

        NavigationManager.NavigateTo("/EditProduct");

    }

    #endregion

    #region persian date

    private CultureInfo GetPersianCulture()
    {
        var persianCulture = new CultureInfo("fa-IR");

        persianCulture.DateTimeFormat.Calendar = new PersianCalendar();

        return persianCulture;

    }

    #endregion

    #region GoToAddProductPage

    private void GoToAddProductPage()
    {

        NavigationManager.NavigateTo("/AddProduct");

    }

    #endregion

    #region DoubleClick

    private void DoubleClick()
    {
        if (selectedProducts == null)
        {
            return;
        }
        dataPassHelper.SetProudctId(selectedProducts.Id);

        NavigationManager.NavigateTo("/ProductInformations");

    }

    #endregion

}

