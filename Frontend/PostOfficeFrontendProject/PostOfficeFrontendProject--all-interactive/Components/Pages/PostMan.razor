@page "/PostMan"
@using MudBlazor
@using CommonDll.Dto
@using System.Threading
@using System.Reflection
@using System.Net.Http.Json
@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using PostOfficeFrontendProject__all_interactive.Interface
@using PostOfficeFrontendProject__all_interactive.Mapper
@using PostOfficeFrontendProject__all_interactive.Service
@inject HttpClient httpClient
@inject NavigationManager NavigationManager
@inject NotificationService notificationService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IDataPassHelper dataPassHelper
@inject IPostManMiddleware postManMiddleware

    <MudItem Class="d-flex align-center justify-center mud-theme-primary  mud-elevation-25" Style=" height:60px; width:100%; margin-top:0px; margin-bottom:20px;">

        <MudText Typo="Typo.h5">PostMans List</MudText>

    </MudItem>

    <MudDataGrid Height="60vh" FixedHeader T="PostManDto" Loading="isLoading" Items="@postMans" Dense="@dense" Hover="@hover" Bordered="@bordered" Striped="@striped" @bind-SelectedItem="ChoosedPostMan" Filterable="true" QuickFilter="_quickFilterForPostMans" SelectOnRowClick>

        <ToolBarContent>

            <MudText Typo="Typo.h5" Style="margin:20px"><b>Postmans</b></MudText>

            <MudSpacer />

            <MudTextField @bind-Value="searchInPostMans" Immediate="true" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>

        </ToolBarContent>

        <Columns>

            <PropertyColumn Property="x => x.UserId" Title="UserId" HeaderStyle="background:#ADD8E6;color:#333;" StickyRight="true" />

            <PropertyColumn Property="x => x.PersonalCode" Title="PersonalCode" HeaderStyle="background:#ADD8E6;color:#333;" />

            <TemplateColumn HeaderStyle="background:#ADD8E6;color:#333;" Title="Operation">

                <CellTemplate>

                    <MudStack Row>

                        <MudButton Style="margin-right:10px" Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditPostMan(context.Item.Id))">

                            Edit

                        </MudButton>

                        <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="@(() =>DeletedProduct(context.Item))">Delete</MudButton>

                    </MudStack>

                </CellTemplate>

            </TemplateColumn>

        </Columns>

        <PagerContent>

            <MudDataGridPager />

        </PagerContent>

    </MudDataGrid>

    <MudPaper Elevation="0" Class="d-flex align-center justify-end " Style="margin-top:20px">

        <MudButton Class="main-button" Style="margin-right:10px" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="GoToAddProductPage">Add</MudButton>

        <MudButton Class="main-button" Variant="Variant.Filled" Color="Color.Tertiary" Size="Size.Large" OnClick="GoToMainPage">MainPage</MudButton>

    </MudPaper>

<style>

    .red-header {
        background-color: #87CEFA;
        color: #fff; /* سفید برای خوانایی متن */
    }

</style>

@code {

    #region Props

    private bool hover = true;

    private bool dense = true;

    private bool striped = true;

    private bool bordered = true;

    private bool isLoading = false;

    private string searchInPostMans = "";

    private PostManDto ChoosedPostMan = null;

    private IEnumerable<PostManDto> postMans = new List<PostManDto>();

    protected async override Task OnInitializedAsync()
    {

        await LoadPostrMans();

    }

    #endregion

    #region LoadPostrMans

    private async Task LoadPostrMans()
    {

        try
        {
            var apiResponse = await postManMiddleware.GetAllPostMansAsync();

            if (apiResponse.Success && apiResponse.Data != null)
            {
                postMans = apiResponse.Data;
                notificationService.ShowSuccess(apiResponse.Message ?? "Load Success.");
            }
            else
            {
                var errorMsg = string.IsNullOrEmpty(apiResponse.Message)
                    ? string.Join(", ", apiResponse.Errors ?? new List<string>())
                    : apiResponse.Message;
                notificationService.ShowError(errorMsg ?? "Error To Load.");
                postMans = new List<PostManDto>();
            }
        }
        catch (Exception ex)
        {
            notificationService.ShowError($"Unexpected Error: {ex.Message}");
            postMans = new List<PostManDto>();
        }

        StateHasChanged();

    }

    #endregion

    #region Filter

    private Func<PostManDto, bool> _quickFilterForPostMans => x =>
    {
        if (string.IsNullOrWhiteSpace(searchInPostMans))
            return true;

        var fields = new List<string?>
                                {
        x.UserId.ToString(),
        x.PersonalCode.ToString(),
                                };

        return fields.Any(f => !string.IsNullOrEmpty(f) &&
                               f.Contains(searchInPostMans, StringComparison.OrdinalIgnoreCase));
    };

    #endregion

    #region GoToMainPage

    private void GoToMainPage()
    {

        NavigationManager.NavigateTo("/");

    }
    #endregion

    #region DeleteItem

    private async Task DeletedProduct(PostManDto deletedPostMans)
    {

        bool? confirmed = await DialogService.ShowMessageBox(
    "Delete Confirm",
    $"َAre You Sure You Want To  Delete '{deletedPostMans.UserId}' ? ",
    yesText: "Yes",
    noText: "No"
    );

        if (confirmed == true)
        {
            postMans = postMans.Where(s => s != deletedPostMans).ToList();
        }

    }

    #endregion

    #region EditProduct

    private void EditPostMan(int id)
    {

        dataPassHelper.SetPostManId(id);

        NavigationManager.NavigateTo("/EditPostMan");

    }

    #endregion

    #region persian date

    private CultureInfo GetPersianCulture()
    {
        var persianCulture = new CultureInfo("fa-IR");

        persianCulture.DateTimeFormat.Calendar = new PersianCalendar();

        return persianCulture;

    }

    #endregion

    #region GoToAddProductPage

    private void GoToAddProductPage()
    {

        NavigationManager.NavigateTo("/AddPostMan");

    }

    #endregion

}


