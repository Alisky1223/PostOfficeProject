@page "/PostOfficeProducts"
@using CommonDll.Dto
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@using System.Net.Http.Json
@using System.Globalization
@using System.Reflection
@using System.Threading
@using PostOfficeFrontendProject__all_interactive.Interface
@using PostOfficeFrontendProject__all_interactive.Mapper
@using PostOfficeFrontendProject__all_interactive.Service
@inject HttpClient httpClient
@inject NavigationManager NavigationManager
@inject NotificationService notificationService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IDataPassHelper dataPassHelper
@inject IProductsMiddelware productsMiddelware

    <MudItem Class="d-flex align-center justify-center mud-theme-primary  mud-elevation-25" Style=" height:60px; width:100%; margin-top:0px; margin-bottom:20px;">

        <MudText Typo="Typo.h5">Packet Informations</MudText>

    </MudItem>

<MudDataGrid Height="60vh" FixedHeader @ondblclick="DoubleClick" T="ProductBasicInformationDto" Loading="isLoading" Items="@products" Dense="@dense" Hover="@hover" Bordered="@bordered" Striped="@striped" Filterable="true" QuickFilter="_quickFilterProducts" SelectOnRowClick @bind-SelectedItem="@selectedProducts">

        <ToolBarContent>

            <MudText Typo="Typo.h5" Style="margin:20px"><b>Packets List</b></MudText>

            <MudSpacer />

            <MudTextField @bind-Value="searchString" Immediate="true" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>

        </ToolBarContent>

        <Columns>

            <PropertyColumn Property="x => x.ProductName" Title="ProductName" HeaderStyle="background:#ADD8E6;color:#333;" StickyRight="true" />

            <PropertyColumn Property="x => x.Price" Title="Price" HeaderStyle="background:#ADD8E6;color:#333;" />

            <TemplateColumn HeaderStyle="background:#ADD8E6;color:#333;" Title="Operations">

                <CellTemplate>

                    <MudStack Row>


                        <MudButton Style="margin-right:10px" Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditProduct(context.Item.Id))">

                            Edit

                        </MudButton>

                        <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="@(() =>DeletedProduct(context.Item))">Delete</MudButton>



                    </MudStack>

                </CellTemplate>

            </TemplateColumn>

        </Columns>

        <PagerContent>

            <MudDataGridPager />

        </PagerContent>

    </MudDataGrid>

    <MudPaper Elevation="0" Class="d-flex align-center justify-end " Style="margin-top:20px">

        <MudButton Class="main-button" Style="margin-right:10px" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="GoToAddProductPage">Add</MudButton>

        <MudButton Class="main-button" Variant="Variant.Filled" Color="Color.Tertiary" Size="Size.Large" OnClick="GoToMainPage">MainPage</MudButton>

    </MudPaper>


<style>

    .red-header {
    background-color: #87CEFA;
    color: #fff; /* سفید برای خوانایی متن */
    }

</style>

@code {

    #region Props

    private bool hover = true;

    private bool dense = true;

    private bool striped = true;

    private bool bordered = true;

    private bool isLoading = false;

    private string searchString = "";

    private ProductBasicInformationDto selectedProducts = new();

    private List<ProductBasicInformationDto> products = new List<ProductBasicInformationDto>();

    protected async override Task OnInitializedAsync()
    {

        await LoadProducts();

    }

    #endregion

    #region LoadProducts

    private async Task LoadProducts()
    {

        try
        {
            var apiResponse = await productsMiddelware.GetAllProductsAsync();

            if (apiResponse.Success && apiResponse.Data != null)
            {
                products = apiResponse.Data;
                notificationService.ShowSuccess(apiResponse.Message ?? "Load Success.");
            }
            else
            {
                var errorMsg = string.IsNullOrEmpty(apiResponse.Message)
                    ? string.Join(", ", apiResponse.Errors ?? new List<string>())
                    : apiResponse.Message;
                notificationService.ShowError(errorMsg ?? "Error To Load.");
                products = new List<ProductBasicInformationDto>();
            }
        }
        catch (Exception ex)
        {
            notificationService.ShowError($"Unexpected Error: {ex.Message}");
            products = new List<ProductBasicInformationDto>();
        }

        StateHasChanged();
    }

    #endregion

    #region Filter

    private Func<ProductBasicInformationDto, bool> _quickFilterProducts => x =>
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        var fields = new List<string?>
                            {
        x.ProductName?.ToString(),
        x.Price.ToString(),
     

                            };

        return fields.Any(f => !string.IsNullOrEmpty(f) &&
                               f.Contains(searchString, StringComparison.OrdinalIgnoreCase));
    };

    #endregion

    #region GoToMainPage

    private void GoToMainPage()
    {

        NavigationManager.NavigateTo("/MainPage");

    }
    #endregion

    #region DeleteItem

    private async Task DeletedProduct(ProductBasicInformationDto deletedProduct)
    {

        bool? confirmed = await DialogService.ShowMessageBox(
    "تأیید حذف",
    $"آیا مطمئن هستید که می‌خواهید محصول '{deletedProduct.ProductName}' را حذف کنید؟",
    yesText: "بله",
    noText: "خیر"
    );

        if (confirmed == true)
        {
            products = products.Where(s => s != deletedProduct).ToList();
        }

    }

    #endregion

    #region EditProduct

    private void EditProduct(int id)
    {

        dataPassHelper.SetProudctId(id);

        NavigationManager.NavigateTo("/EditProduct");

    }

    #endregion

    #region persian date

    private CultureInfo GetPersianCulture()
    {
        var persianCulture = new CultureInfo("fa-IR");

        persianCulture.DateTimeFormat.Calendar = new PersianCalendar();

        return persianCulture;

    }

    #endregion

    #region GoToAddProductPage

    private void GoToAddProductPage()
    {

        NavigationManager.NavigateTo("/AddProduct");

    }

    #endregion

    #region DoubleClick

    private void DoubleClick()
    {
        if (selectedProducts == null)
        {
            return;
        }
        dataPassHelper.SetProudctId(selectedProducts.Id);

        NavigationManager.NavigateTo("/ProductInformations");

    }

    #endregion

}

